<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный PDF Редактор (v6.1 - Fix Extract)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/exifr.iife.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>


    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; 
               background: #f4f4f9; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1 { color: #333; text-align: center; }

        /* --- Интерфейс Вкладок --- */
        .tab-nav { display: flex; flex-wrap: wrap; /* Для мобильных */ border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-button { padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 16px; color: #555; }
        .tab-button.active { color: #007bff; border-bottom: 2px solid #007bff; font-weight: bold; }
        .tab-button:disabled { color: #aaa; cursor: not-allowed; }
        .tool-panel { display: none; }
        .tool-panel.active { display: block; }
        
        /* --- Общие стили --- */
        .file-input { border: 2px dashed #007bff; padding: 20px; border-radius: 8px; background: #fff; cursor: pointer; display: block; text-align: center; margin-bottom: 20px;}
        .action-button { width: 100%; padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        .action-button:hover { background-color: #0056b3; }
        .action-button:disabled { background-color: #aaa; }
        .status { text-align: center; margin-top: 15px; font-style: italic; color: #555; min-height: 1.2em;} /* min-height, чтобы не прыгало */
        
        /* --- Стили для Разделителя PDF --- */
        #splitInterface { display: none; }
        .split-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .page-box { border: 1px solid #ddd; border-radius: 8px; background: #fff; padding: 10px; height: 400px; overflow-y: auto; }
        .page-box h3 { text-align: center; margin-top: 0; }
        .page-thumbnail-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .page-thumbnail { position: relative; border: 2px solid #ccc; border-radius: 4px; padding: 5px; background: #f9f9f9; width: 100px; text-align: center; }
        .page-thumbnail img { width: 100%; height: auto; display: block; }
        .page-thumbnail span { font-size: 0.8em; color: #333; }
        #sourcePages .page-thumbnail { cursor: pointer; }
        #sourcePages .page-thumbnail:hover { border-color: #007bff; background: #e9f5ff; }
        #newDocPages .page-thumbnail { cursor: grab; }
        #newDocPages .page-thumbnail:active { cursor: grabbing; background: #e0e0e0; }
        #newDocPages .page-thumbnail::after { content: '×'; position: absolute; top: -5px; right: -5px; background: #ff4d4d; color: white; border-radius: 50%; width: 18px; height: 18px; line-height: 18px; text-align: center; font-weight: bold; cursor: pointer; opacity: 0.8; }
        #newDocPages .page-thumbnail:hover::after { opacity: 1; }
        .dragging { opacity: 0.5; }
        .drag-over-placeholder { border: 2px dashed #007bff; background: #e9f5ff; height: 140px; width: 100px; margin: 5px; }
    </style>
</head>
<body>

    <h1>Мой PDF Редактор</h1>

    <div class="tab-nav">
        <button class="tab-button active" data-tab="imageConverter">Фото в PDF</button>
        <button class="tab-button" data-tab="pdfMerger">Объединить PDF</button>
        <button class="tab-button" data-tab="pdfSplitter">Разбить / Собрать PDF</button>
        <button class="tab-button" data-tab="pdfExtractor">Извлечь Картинки (в .zip)</button>
    </div>

    <div id="imageConverter" class="tool-panel active">
        <input type="file" id="fileInputImages" class="file-input" multiple accept="image/png, image/jpeg, image/bmp, image/webp">
        <button id="convertButtonImages" class="action-button">Создать PDF из Фото</button>
        <div id="statusImages" class="status">Выберите файлы и нажмите кнопку</div>
    </div>

    <div id="pdfMerger" class="tool-panel">
        <input type="file" id="fileInputMerge" class="file-input" multiple accept="application/pdf">
        <button id="convertButtonMerge" class="action-button">Объединить PDF-файлы</button>
        <div id="statusMerge" class="status">Выберите 2+ PDF-файла</div>
        <div style="font-size: 0.9em; color: #666; margin-top: 10px;">(Файлы будут объединены в том порядке, в каком вы их выбрали)</div>
    </div>

    <div id="pdfSplitter" class="tool-panel">
        <input type="file" id="fileInputSplit" class="file-input" accept="application/pdf">
        <button id="loadButtonSplit" class="action-button" style="background-color: #28a745;">1. Загрузить страницы</button>
        <div id="statusSplit" class="status">Выберите PDF-файл и нажмите "Загрузить"</div>
        
        <div id="splitInterface">
            <div class="split-container">
                <div class="page-box">
                    <h3>Исходные страницы</h3>
                    <div id="sourcePages" class="page-thumbnail-list"></div>
                </div>
                <div class="page-box">
                    <h3>Ваш новый документ (перетащите, чтобы сменить порядок)</h3>
                    <div id="newDocPages" class="page-thumbnail-list"></div>
                </div>
            </div>
            <button id="createButtonSplit" class="action-button" style="margin-top: 20px;">2. Собрать и скачать PDF</button>
        </div>
    </div>
    
    <div id="pdfExtractor" class="tool-panel">
        <input type="file" id="fileInputExtract" class="file-input" accept="application/pdf">
        <button id="extractButton" class="action-button">Извлечь все изображения (в PNG)</button>
        <div id="statusExtract" class="status">Выберите PDF-файл для извлечения</div>
    </div>


    <script>
        // --- ОБЩИЕ ЭЛЕМЕНТЫ И ЛОГИКА ---
        const { jsPDF } = window.jspdf;
        const { PDFDocument } = PDFLib;
        const { pdfjsLib } = window; // Глобальный объект pdf.js
        const { JSZip } = window; // Глобальный объект jszip

        // Настройка pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // --- Логика переключения вкладок ---
        document.querySelector('.tab-nav').addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON' || e.target.disabled) return;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tool-panel').forEach(panel => panel.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById(e.target.dataset.tab).classList.add('active');
        });

        // --- Вспомогательные функции ---
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }
        
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        }

        // ==========================================================
        // --- 1. ЛОГИКА КОНВЕРТЕРА ФОТО (Старый код) ---
        // ==========================================================
        
        (function setupImageConverter() {
            const fileInputImages = document.getElementById('fileInputImages');
            const convertButtonImages = document.getElementById('convertButtonImages');
            const statusImages = document.getElementById('statusImages');

            convertButtonImages.addEventListener('click', async () => {
                const files = fileInputImages.files;
                if (files.length === 0) { statusImages.textContent = 'Пожалуйста, сначала выберите файлы!'; return; }
                statusImages.textContent = 'Обработка...'; convertButtonImages.disabled = true;
                try {
                    const doc = new jsPDF(); doc.deletePage(1);
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        statusImages.textContent = `Обработка файла ${i + 1} из ${files.length}...`;
                        const imgDataPromise = readFileAsDataURL(file);
                        const arrayBufferPromise = readFileAsArrayBuffer(file);
                        const [imgData, arrayBuffer] = await Promise.all([imgDataPromise, arrayBufferPromise]);
                        const rawImgProps = await getImageProperties(imgData);
                        let orientation = 1;
                        try {
                            const exif = await exifr.parse(arrayBuffer);
                            if (exif && exif.orientation) { orientation = exif.orientation; }
                        } catch (e) { console.log(`Файл ${file.name}: не-JPEG или нет EXIF`); }
                        
                        const { correctedDataURL, visualWidth, visualHeight } = await getCorrectedImage(imgData, rawImgProps.width, rawImgProps.height, orientation);
                        const pageOrientation = (visualWidth > visualHeight) ? 'l' : 'p';
                        doc.addPage('a4', pageOrientation);
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const pageHeight = doc.internal.pageSize.getHeight();
                        const pageRatio = pageWidth / pageHeight; const imgRatio = visualWidth / visualHeight;
                        let imgWidth, imgHeight;
                        if (imgRatio > pageRatio) { imgWidth = pageWidth; imgHeight = imgWidth / imgRatio; }
                        else { imgHeight = pageHeight; imgWidth = imgHeight * imgRatio; }
                        const x = (pageWidth - imgWidth) / 2; const y = (pageHeight - imgHeight) / 2;
                        doc.addImage(correctedDataURL, 'JPEG', x, y, imgWidth, imgHeight); 
                    }
                    statusImages.textContent = 'Готово! Скачивание...';
                    doc.save('my-converted-file.pdf');
                    statusImages.textContent = 'Выберите файлы и нажмите кнопку';
                } catch (error) { statusImages.textContent = `Ошибка: ${error.message}`; console.error(error);
                } finally { convertButtonImages.disabled = false; }
            });

            function readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsDataURL(file);
                });
            }
            function getImageProperties(imgData) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve({ width: img.width, height: img.height });
                    img.onerror = (e) => reject(e);
                    img.src = imgData;
                });
            }
            function getCorrectedImage(imgData, rawWidth, rawHeight, orientation) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        let visualWidth = rawWidth; let visualHeight = rawHeight;
                        if (orientation > 4) { visualWidth = rawHeight; visualHeight = rawWidth; }
                        canvas.width = visualWidth; canvas.height = visualHeight;
                        switch (orientation) {
                            case 2: ctx.translate(visualWidth, 0); ctx.scale(-1, 1); break;
                            case 3: ctx.translate(visualWidth, visualHeight); ctx.rotate(Math.PI); break;
                            case 4: ctx.translate(0, visualHeight); ctx.scale(1, -1); break;
                            case 5: ctx.rotate(0.5 * Math.PI); ctx.scale(1, -1); break;
                            case 6: ctx.rotate(0.5 * Math.PI); ctx.translate(0, -visualWidth); break;
                            case 7: ctx.rotate(0.5 * Math.PI); ctx.translate(visualHeight, -visualWidth); ctx.scale(-1, 1); break;
                            case 8: ctx.rotate(-0.5 * Math.PI); ctx.translate(-visualHeight, 0); break;
                        }
                        ctx.drawImage(img, 0, 0, rawWidth, rawHeight);
                        const correctedDataURL = canvas.toDataURL('image/jpeg', 0.9);
                        resolve({ correctedDataURL, visualWidth, visualHeight });
                    };
                    img.onerror = (e) => reject(e);
                    img.src = imgData;
                });
            }
        })();


        // ==========================================================
        // --- 2. ЛОГИКА ОБЪЕДИНЕНИЯ PDF (Старый код) ---
        // ==========================================================

        (function setupPdfMerger() {
            const fileInputMerge = document.getElementById('fileInputMerge');
            const convertButtonMerge = document.getElementById('convertButtonMerge');
            const statusMerge = document.getElementById('statusMerge');

            convertButtonMerge.addEventListener('click', async () => {
                const files = fileInputMerge.files;
                if (files.length < 2) { statusMerge.textContent = 'Пожалуйста, выберите хотя бы 2 PDF-файла!'; return; }
                statusMerge.textContent = 'Объединение...'; convertButtonMerge.disabled = true;
                try {
                    const mergedPdf = await PDFDocument.create();
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        statusMerge.textContent = `Добавляем файл ${i + 1} из ${files.length}...`;
                        const arrayBuffer = await readFileAsArrayBuffer(file);
                        const pdfDoc = await PDFDocument.load(arrayBuffer);
                        const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                        copiedPages.forEach((page) => { mergedPdf.addPage(page); });
                    }
                    const mergedPdfBytes = await mergedPdf.save();
                    const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                    downloadBlob(blob, 'merged-file.pdf');
                    statusMerge.textContent = 'Готово! Файлы объединены.';
                } catch (error) { statusMerge.textContent = `Ошибка: ${error.message}`; console.error(error);
                } finally { convertButtonMerge.disabled = false; }
            });
        })();


        // ==========================================================
        // --- 3. ЛОГИКА РАЗДЕЛИТЕЛЯ PDF (Старый код) ---
        // ==========================================================

        (function setupPdfSplitter() {
            const fileInputSplit = document.getElementById('fileInputSplit');
            const loadButtonSplit = document.getElementById('loadButtonSplit');
            const createButtonSplit = document.getElementById('createButtonSplit');
            const statusSplit = document.getElementById('statusSplit');
            const splitInterface = document.getElementById('splitInterface');
            const sourcePagesContainer = document.getElementById('sourcePages');
            const newDocPagesContainer = document.getElementById('newDocPages');
            
            let loadedPdfArrayBuffer = null; 

            loadButtonSplit.addEventListener('click', async () => {
                const file = fileInputSplit.files[0];
                if (!file) { statusSplit.textContent = 'Пожалуйста, выберите PDF-файл.'; return; }
                statusSplit.textContent = 'Загрузка файла...'; loadButtonSplit.disabled = true;
                sourcePagesContainer.innerHTML = ''; newDocPagesContainer.innerHTML = '';
                splitInterface.style.display = 'none';

                try {
                    loadedPdfArrayBuffer = await readFileAsArrayBuffer(file);
                    const loadingTask = pdfjsLib.getDocument({ data: loadedPdfArrayBuffer });
                    const pdfDoc = await loadingTask.promise;
                    const numPages = pdfDoc.numPages;
                    statusSplit.textContent = `Рендеринг ${numPages} эскизов...`;
                    
                    for (let i = 1; i <= numPages; i++) {
                        const page = await pdfDoc.getPage(i);
                        const viewport = page.getViewport({ scale: 0.5 }); 
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = viewport.width; canvas.height = viewport.height;
                        const renderContext = { canvasContext: ctx, viewport: viewport };
                        await page.render(renderContext).promise;
                        sourcePagesContainer.appendChild(
                            createPageThumbnail(canvas.toDataURL('image/png'), i)
                        );
                    }
                    splitInterface.style.display = 'block';
                    statusSplit.textContent = 'Кликните на страницы слева, чтобы добавить их в новый документ.';
                } catch (error) { statusSplit.textContent = `Ошибка загрузки PDF: ${error.message}`; console.error(error);
                } finally { loadButtonSplit.disabled = false; }
            });
            
            function createPageThumbnail(imgDataUrl, pageNum) {
                const div = document.createElement('div'); div.className = 'page-thumbnail';
                div.dataset.pageNum = pageNum; 
                const img = document.createElement('img'); img.src = imgDataUrl;
                const span = document.createElement('span'); span.textContent = `Стр. ${pageNum}`;
                div.appendChild(img); div.appendChild(span);
                return div;
            }

            sourcePagesContainer.addEventListener('click', (e) => {
                const targetThumbnail = e.target.closest('.page-thumbnail');
                if (!targetThumbnail) return;
                const newThumbnail = targetThumbnail.cloneNode(true);
                newDocPagesContainer.appendChild(newThumbnail);
                statusSplit.textContent = `Добавлена стр. ${targetThumbnail.dataset.pageNum}.`;
            });
            
            newDocPagesContainer.addEventListener('click', (e) => {
                const targetThumbnail = e.target.closest('.page-thumbnail');
                if (targetThumbnail) {
                    targetThumbnail.remove();
                }
            });

            // --- Логика Drag & Drop ---
            let draggingElement = null;
            let placeholder = document.createElement('div');
            placeholder.className = 'drag-over-placeholder';

            newDocPagesContainer.addEventListener('dragstart', (e) => {
                const target = e.target.closest('.page-thumbnail');
                if (!target) return;
                draggingElement = target; e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => {
                    draggingElement.classList.add('dragging');
                    newDocPagesContainer.insertBefore(placeholder, draggingElement);
                }, 0);
            });
            newDocPagesContainer.addEventListener('dragend', (e) => {
                if (!draggingElement) return;
                draggingElement.classList.remove('dragging');
                if (placeholder.parentNode) {
                    placeholder.parentNode.replaceChild(draggingElement, placeholder);
                }
                draggingElement = null;
            });
            newDocPagesContainer.addEventListener('dragover', (e) => {
                e.preventDefault(); e.dataTransfer.dropEffect = 'move';
                const target = e.target.closest('.page-thumbnail');
                if (target && target !== draggingElement) {
                    const rect = target.getBoundingClientRect();
                    const next = (e.clientY - rect.top) / rect.height > 0.5;
                    newDocPagesContainer.insertBefore(placeholder, next ? target.nextSibling : target);
                } else if (!target && newDocPagesContainer.children.length > 0 && !newDocPagesContainer.contains(placeholder)) {
                    newDocPagesContainer.appendChild(placeholder);
                }
            });

            createButtonSplit.addEventListener('click', async () => {
                const selectedPages = newDocPagesContainer.querySelectorAll('.page-thumbnail');
                if (selectedPages.length === 0) { statusSplit.textContent = 'Добавьте хотя бы одну страницу.'; return; }
                if (!loadedPdfArrayBuffer) { statusSplit.textContent = 'Ошибка: Исходный PDF не найден.'; return; }
                statusSplit.textContent = 'Сборка PDF...'; createButtonSplit.disabled = true;
                try {
                    const originalPdfDoc = await PDFDocument.load(loadedPdfArrayBuffer);
                    const newPdfDoc = await PDFDocument.create();
                    const pageIndices = Array.from(selectedPages).map(thumb => parseInt(thumb.dataset.pageNum) - 1);
                    const copiedPages = await newPdfDoc.copyPages(originalPdfDoc, pageIndices);
                    copiedPages.forEach(page => newPdfDoc.addPage(page));
                    const newPdfBytes = await newPdfDoc.save();
                    downloadBlob(new Blob([newPdfBytes], { type: 'application/pdf' }), 'split-combined-file.pdf');
                    statusSplit.textContent = 'Готово! Новый PDF создан.';
                } catch (error) { statusSplit.textContent = `Ошибка сборки PDF: ${error.message}`; console.error(error);
                } finally { createButtonSplit.disabled = false; }
            });
        })();
        
        // ==========================================================
        // --- 4. ЛОГИКА ИЗВЛЕЧЕНИЯ КАРТИНОК (С ИСПРАВЛЕНИЕМ) ---
        // ==========================================================
        
        (function setupImageExtractor() {
            const fileInputExtract = document.getElementById('fileInputExtract');
            const extractButton = document.getElementById('extractButton');
            const statusExtract = document.getElementById('statusExtract');

            extractButton.addEventListener('click', async () => {
                const file = fileInputExtract.files[0];
                if (!file) {
                    statusExtract.textContent = 'Пожалуйста, выберите PDF-файл.';
                    return;
                }

                statusExtract.textContent = 'Загрузка и анализ PDF...';
                extractButton.disabled = true;

                try {
                    const arrayBuffer = await readFileAsArrayBuffer(file);
                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                    const pdfDoc = await loadingTask.promise;
                    
                    const zip = new JSZip();
                    let imageCount = 0;

                    for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                        statusExtract.textContent = `Сканирование страницы ${pageNum} из ${pdfDoc.numPages}...`;
                        const page = await pdfDoc.getPage(pageNum);
                        
                        const opList = await page.getOperatorList();
                        
                        // Ищем команды отрисовки изображений
                        for (let i = 0; i < opList.fnArray.length; i++) {
                            if (opList.fnArray[i] === pdfjsLib.OPS.paintImageXObject) {
                                const imgName = opList.argsArray[i][0]; // Имя ресурса (XObject)
                                
                                try {
                                    const img = await page.objs.get(imgName);

                                    if (img && img.data) {
                                        imageCount++;
                                        statusExtract.textContent = `Найдено изображений: ${imageCount}. Конвертация...`;
                                        
                                        // Конвертируем данные изображения в PNG blob
                                        const blob = await convertImgDataToPngBlob(img);
                                        
                                        // Добавляем в zip
                                        if (blob) {
                                            zip.file(`page-${pageNum}-img-${imageCount}.png`, blob);
                                        } else {
                                            console.warn(`Не удалось сконвертировать изображение ${imgName} на стр. ${pageNum}`);
                                            imageCount--; // Не считаем неудачные
                                        }
                                    }
                                } catch (e) {
                                    console.error(`Ошибка извлечения объекта ${imgName}:`, e);
                                    statusExtract.textContent = `Ошибка на стр. ${pageNum}. Пропускаем...`;
                                }
                            }
                        }
                    }

                    if (imageCount === 0) {
                        statusExtract.textContent = 'Изображения в этом PDF не найдены (или не могут быть извлечены).';
                    } else {
                        statusExtract.textContent = `Создание zip-архива из ${imageCount} изображений...`;
                        const zipBlob = await zip.generateAsync({ type: 'blob' });
                        downloadBlob(zipBlob, 'extracted-images.zip');
                        statusExtract.textContent = `Готово! ${imageCount} изображений скачано.`;
                    }

                } catch (error) {
                    statusExtract.textContent = `Ошибка: ${error.message}`;
                    console.error(error);
                } finally {
                    extractButton.disabled = false;
                }
            });

            // *** НАЧАЛО ИСПРАВЛЕНИЯ ***
            // Вспомогательная функция для конвертации данных в PNG
            async function convertImgDataToPngBlob(imgData) {
                const canvas = document.createElement('canvas');
                canvas.width = imgData.width;
                canvas.height = imgData.height;
                const ctx = canvas.getContext('2d');
                
                // Данные могут быть JPEG (0), RGBA (1) или RGB (2)
                // ИСПРАВЛЕНО: pdfjsLib.ImageKind не всегда доступен, используем "магические числа"
                
                if (imgData.kind === 0) { // 0 === JPEG
                    // Это JPEG, самый простой случай
                    try {
                        const blob = new Blob([imgData.data], { type: 'image/jpeg' });
                        const url = URL.createObjectURL(blob);
                        const img = new Image();
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = (e) => reject(new Error('Не удалось загрузить JPEG данные'));
                            img.src = url;
                        });
                        ctx.drawImage(img, 0, 0);
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        console.error("Ошибка обработки JPEG:", e, imgData);
                        return null; // Возвращаем null при ошибке
                    }
                    
                } else if (imgData.kind === 1) { // 1 === RGBA_32BPP
                    // Это RGBA (4 байта на пиксель)
                    try {
                        const imageData = ctx.createImageData(imgData.width, imgData.height);
                        imageData.data.set(imgData.data);
                        ctx.putImageData(imageData, 0, 0);
                    } catch (e) {
                        console.error("Ошибка обработки RGBA:", e, imgData);
                        return null;
                    }
                    
                } else if (imgData.kind === 2) { // 2 === RGB_24BPP
                    // Это RGB (3 байта на пиксель), нужно добавить Alpha
                    try {
                        const imageData = ctx.createImageData(imgData.width, imgData.height);
                        const rgbData = imgData.data;
                        const rgbaData = imageData.data;
                        let j = 0;
                        for (let i = 0; i < rgbData.length; i += 3) {
                            rgbaData[j++] = rgbData[i];     // R
                            rgbaData[j++] = rgbData[i + 1]; // G
                            rgbaData[j++] = rgbData[i + 2]; // B
                            rgbaData[j++] = 255;            // A (полная непрозрачность)
                        }
                        ctx.putImageData(imageData, 0, 0);
                    } catch (e) {
                        console.error("Ошибка обработки RGB:", e, imgData);
                        return null;
                    }
                } else {
                    // Другие/неизвестные форматы
                    console.warn("Неподдерживаемый формат изображения:", imgData.kind);
                    return null; // Возвращаем null для неподдерживаемых форматов
                }
                
                // Конвертируем canvas в PNG blob
                return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            }
            // *** КОНЕЦ ИСПРАВЛЕНИЯ ***

        })();

    </script>
</body>
</html>